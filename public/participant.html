<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>LiveKit Participant (Fixed)</title>
  <style>
    body { background: #111; color: #fff; font-family: Arial; padding: 20px; }
    h2 { color: #0af; margin-bottom: 15px; text-align: center; }
    .video-grid {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
      justify-content: center;
      padding: 20px;
      background: #222;
      border-radius: 8px;
    }
    .tile {
      width: 300px;
      max-width: 90%;
      height: 200px;
      background: black;
      border: 2px solid #444;
      border-radius: 4px;
      object-fit: cover;
    }
    .controls {
      margin-top: 20px;
      text-align: center;
    }
    button {
      padding: 10px 20px;
      margin: 5px;
      border: none;
      border-radius: 5px;
      background: #0af;
      color: #000;
      font-weight: bold;
      cursor: pointer;
    }
    button:hover { background: #0ff; }
  </style>
</head>
<body>

<h2>Participant</h2>

<div class="video-grid">
  <video id="local-video" class="tile" autoplay muted playsinline></video>
  <video id="remote-video" class="tile" autoplay playsinline></video>
</div>

<div class="controls">
  <button id="front-btn">Front Camera</button>
  <button id="back-btn">Back Camera</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/livekit-client/dist/livekit-client.umd.min.js"></script>
<script>
  const { Room, RoomEvent, Track, LocalVideoTrack, VideoPresets } = LivekitClient;
  let room;
  let localVideoTrack;

  /* ================= SWITCH CAMERA ================= */
  async function switchCamera(facingMode) {
    if (!room) return;

    try {
      // Get MediaStream with facingMode
      const stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode },
        audio: false
      });

      // Create LiveKit LocalVideoTrack (pass MediaStreamTrack directly)
      const newTrack = new LocalVideoTrack(
              stream.getVideoTracks()[0],
              { resolution: VideoPresets.h720.resolution }
      );

      // Replace existing track if exists
      if (localVideoTrack) {
        await room.localParticipant.replaceTrack(localVideoTrack, newTrack);
        localVideoTrack.stop();
      }

      localVideoTrack = newTrack;
      localVideoTrack.attach(document.getElementById("local-video"));
    } catch (err) {
      console.error("Camera error:", err);
      alert("Cannot access camera: " + err.message);
    }
  }

  /* ================= START ROOM ================= */
  async function start() {
    const identity = "participant-" + Math.floor(Math.random() * 1000);
    const res = await fetch(`/api/get-token?room=my-room&identity=${identity}`);
    const { token } = await res.json();

    room = new Room({ adaptiveStream: true, dynacast: true });

    room.on(RoomEvent.TrackSubscribed, track => {
      if (track.kind === Track.Kind.Video) {
        track.attach(document.getElementById("remote-video"));
      }
    });

    await room.connect("wss://my-first-app-mwgdyws7.livekit.cloud", token);

    // Start with front camera by default
    await switchCamera("user");
  }

  /* ================= BUTTON EVENTS ================= */
  document.getElementById("front-btn").onclick = () => switchCamera("user");
  document.getElementById("back-btn").onclick = () => switchCamera("environment");

  /* ================= BOOT ================= */
  start();
</script>
</body>
</html>
